<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDECON Dashboard - Monitor Pesatrice</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        
        .header {
            background: #16213e;
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid #0f3460;
        }
        
        .header h1 {
            color: #e94560;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }
        
        .status-dot.offline {
            background: #dc3545;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #0f3460;
        }
        
        .card h2 {
            color: #e94560;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .weight-display {
            text-align: center;
            padding: 30px;
        }
        
        .weight-value {
            font-size: 72px;
            font-weight: bold;
            color: #fff;
            margin: 10px 0;
        }
        
        .weight-unit {
            font-size: 24px;
            color: #888;
        }
        
        .weight-delta {
            font-size: 32px;
            margin-top: 10px;
        }
        
        .weight-delta.positive {
            color: #28a745;
        }
        
        .weight-delta.negative {
            color: #dc3545;
        }
        
        .weight-flags {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .flag {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .flag.ok {
            background: #28a745;
        }
        
        .flag.expelled {
            background: #dc3545;
        }
        
        .flag.plus {
            background: #ffc107;
            color: #000;
        }
        
        .flag.minus {
            background: #17a2b8;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .stat-box {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #e94560;
        }
        
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        
        .events-table {
            width: 100%;
            border-collapse: collapse;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .events-table th,
        .events-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #0f3460;
        }
        
        .events-table th {
            background: #0f3460;
            color: #e94560;
        }
        
        .event-code {
            background: #e94560;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .weights-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .weights-table th,
        .weights-table td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #0f3460;
        }
        
        .weights-table th {
            background: #0f3460;
            color: #e94560;
        }
        
        .weights-table td:first-child,
        .weights-table th:first-child {
            text-align: left;
        }
        
        .command-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .command-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #0f3460;
            background: #1a1a2e;
            color: #fff;
            border-radius: 5px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .btn-primary {
            background: #e94560;
            color: white;
        }
        
        .btn-secondary {
            background: #0f3460;
            color: white;
        }
        
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
        }
        
        .connection-status.connected {
            background: #28a745;
        }
        
        .connection-status.disconnected {
            background: #dc3545;
        }
        
        @media (max-width: 968px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="connection-status disconnected" id="connStatus">
        Disconnesso
    </div>
    
    <div class="header">
        <h1>IDECON Dashboard</h1>
        <p>Monitor Pesatrice in Tempo Reale</p>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="scaleDot"></div>
                <span>Bilancia: <span id="scaleStatus">Sconnesso</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot offline" id="webDot"></div>
                <span>Web: <span id="webStatus">In attesa...</span></span>
            </div>
            <div class="status-item">
                <span>Totale Pesi: <strong id="totalWeights">0</strong></span>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Peso attuale e Grafico -->
        <div class="grid">
            <div class="card">
                <h2>Ultima Pesata</h2>
                <div class="weight-display">
                    <div class="weight-value" id="currentWeight">--</div>
                    <div class="weight-unit">grammi</div>
                    <div class="weight-delta" id="weightDelta">--</div>
                    <div class="weight-flags" id="weightFlags"></div>
                    <div style="margin-top: 15px; font-size: 12px; color: #888;">
                        Batch: <span id="currentBatch">--</span> | 
                        Recipe: <span id="currentRecipe">--</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Andamento Pesi</h2>
                <div class="chart-container">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Statistiche -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>Statistiche Sessione</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="statCount">0</div>
                    <div class="stat-label">Pesi Totali</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statAvg">0</div>
                    <div class="stat-label">Media (g)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statMin">0</div>
                    <div class="stat-label">Min (g)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statMax">0</div>
                    <div class="stat-label">Max (g)</div>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Ultimi Pesi -->
            <div class="card">
                <h2>Ultime 10 Pesate</h2>
                <table class="weights-table">
                    <thead>
                        <tr>
                            <th>Orario</th>
                            <th>Peso (g)</th>
                            <th>Delta</th>
                            <th>Stato</th>
                        </tr>
                    </thead>
                    <tbody id="weightsTableBody">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #888;">In attesa di dati...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Eventi -->
            <div class="card">
                <h2>Eventi</h2>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Orario</th>
                                <th>Codice</th>
                                <th>Descrizione</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #888;">Nessun evento</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Comandi -->
        <div class="card">
            <h2>Comandi</h2>
            <div class="command-section">
                <input type="text" class="command-input" id="commandInput" 
                       placeholder="Inserisci comando (es: STATSV, START, STOP)...">
                <button class="btn btn-primary" onclick="sendCommand()">Invia</button>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-secondary" onclick="quickCommand('STATSV')">STATSV</button>
                <button class="btn btn-secondary" onclick="quickCommand('STATREQ')">STATREQ</button>
                <button class="btn btn-secondary" onclick="quickCommand('BATCHINFO')">BATCHINFO</button>
            </div>
        </div>
    </div>
    
    <script>
        // Connessione Socket.IO
        const socket = io();
        
        // Dati
        let weights = [];
        let events = [];
        let weightChart;
        
        // Inizializzazione grafico
        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Peso (g)',
                        data: [],
                        borderColor: '#e94560',
                        backgroundColor: 'rgba(233, 69, 96, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#888',
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    }
                }
            });
        }
        
        // Gestione connessione
        socket.on('connect', function() {
            console.log('Connesso al server');
            updateConnectionStatus(true);
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnesso dal server');
            updateConnectionStatus(false);
        });
        
        // Nuovo peso ricevuto
        socket.on('new_weight', function(data) {
            const weight = data.weight;
            weights.push(weight);
            
            // Aggiorna display peso attuale
            document.getElementById('currentWeight').textContent = weight.weight_g.toFixed(3);
            
            const deltaEl = document.getElementById('weightDelta');
            deltaEl.textContent = (weight.delta_g >= 0 ? '+' : '') + weight.delta_g.toFixed(3) + ' g';
            deltaEl.className = 'weight-delta ' + (weight.delta_g >= 0 ? 'positive' : 'negative');
            
            document.getElementById('currentBatch').textContent = weight.batch_code || '-';
            document.getElementById('currentRecipe').textContent = weight.recipe_name || '-';
            
            // Flags
            const flagsContainer = document.getElementById('weightFlags');
            flagsContainer.innerHTML = '';
            if (weight.flags) {
                weight.flags.forEach(flag => {
                    const span = document.createElement('span');
                    span.className = 'flag ' + getFlagClass(flag);
                    span.textContent = flag;
                    flagsContainer.appendChild(span);
                });
            }
            
            // Aggiorna grafico
            updateChart(weight);
            
            // Aggiorna tabella
            updateWeightsTable();
            
            // Aggiorna statistiche
            updateStats();
            
            // Aggiorna contatore
            document.getElementById('totalWeights').textContent = data.total_count;
            document.getElementById('statCount').textContent = data.total_count;
        });
        
        // Nuovo evento
        socket.on('new_event', function(data) {
            events.unshift(data.event);
            updateEventsTable();
        });
        
        // Storico pesi
        socket.on('weights_history', function(data) {
            weights = data.weights || [];
            updateWeightsTable();
            updateStats();
            
            // Ricostruisci grafico
            weights.forEach(w => updateChart(w));
        });
        
        // Storico eventi
        socket.on('events_history', function(data) {
            events = data.events || [];
            updateEventsTable();
        });
        
        // Aggiornamento status
        socket.on('status_update', function(data) {
            const status = data.status;
            document.getElementById('scaleStatus').textContent = 
                status.work_mode + ' - ' + status.motor_running;
            
            const dot = document.getElementById('scaleDot');
            if (status.has_errors) {
                dot.style.background = '#dc3545';
            } else if (status.work_mode === 'OPERATIONAL') {
                dot.style.background = '#28a745';
            } else {
                dot.style.background = '#ffc107';
            }
        });
        
        // Risposta comando
        socket.on('command_response', function(data) {
            console.log('Risposta comando:', data);
            // TODO: Mostrare in UI
        });
        
        // Funzioni helper
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connStatus');
            const webDot = document.getElementById('webDot');
            const webStatus = document.getElementById('webStatus');
            
            if (connected) {
                status.textContent = 'Connesso';
                status.className = 'connection-status connected';
                webDot.className = 'status-dot';
                webStatus.textContent = 'Online';
            } else {
                status.textContent = 'Disconnesso';
                status.className = 'connection-status disconnected';
                webDot.className = 'status-dot offline';
                webStatus.textContent = 'Offline';
            }
        }
        
        function getFlagClass(flag) {
            const map = {
                'OK': 'ok',
                'EXPELLED': 'expelled',
                '+': 'plus',
                '++': 'plus',
                '-': 'minus',
                '--': 'minus',
                'OK+': 'ok',
                'OK-': 'ok'
            };
            return map[flag] || 'ok';
        }
        
        function updateChart(weight) {
            const time = new Date().toLocaleTimeString('it-IT');
            
            weightChart.data.labels.push(time);
            weightChart.data.datasets[0].data.push(weight.weight_g);
            
            // Mantieni solo ultimi 50 punti
            if (weightChart.data.labels.length > 50) {
                weightChart.data.labels.shift();
                weightChart.data.datasets[0].data.shift();
            }
            
            weightChart.update('none');
        }
        
        function updateWeightsTable() {
            const tbody = document.getElementById('weightsTableBody');
            tbody.innerHTML = '';
            
            const recent = weights.slice(-10).reverse();
            
            recent.forEach(w => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = new Date(w.timestamp).toLocaleTimeString('it-IT');
                row.insertCell(1).textContent = w.weight_g.toFixed(3);
                row.insertCell(2).textContent = (w.delta_g >= 0 ? '+' : '') + w.delta_g.toFixed(1);
                row.insertCell(3).textContent = w.flags ? w.flags.join(', ') : '-';
            });
        }
        
        function updateEventsTable() {
            const tbody = document.getElementById('eventsTableBody');
            tbody.innerHTML = '';
            
            events.slice(0, 20).forEach(e => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = new Date(e.timestamp).toLocaleTimeString('it-IT');
                
                const codeCell = row.insertCell(1);
                const codeSpan = document.createElement('span');
                codeSpan.className = 'event-code';
                codeSpan.textContent = e.event_code;
                codeCell.appendChild(codeSpan);
                
                row.insertCell(2).textContent = e.event_description || e.event_name;
            });
        }
        
        function updateStats() {
            if (weights.length === 0) return;
            
            const values = weights.map(w => w.weight_g);
            const avg = values.reduce((a, b) => a + b, 0) / values.length;
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            document.getElementById('statAvg').textContent = avg.toFixed(1);
            document.getElementById('statMin').textContent = min.toFixed(1);
            document.getElementById('statMax').textContent = max.toFixed(1);
        }
        
        function sendCommand() {
            const input = document.getElementById('commandInput');
            const cmd = input.value.trim();
            if (cmd) {
                socket.emit('send_command', {command: cmd});
                input.value = '';
            }
        }
        
        function quickCommand(cmd) {
            socket.emit('send_command', {command: cmd});
        }
        
        // Inizializza
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
        });
        
        // Invio con Enter
        document.getElementById('commandInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendCommand();
        });
    </script>
</body>
</html>